{% extends "index.html" %}

{% block title %}Trend Control{% endblock %}

{% block content %}
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center">
        <h1>Trend Control</h1>
        <!-- Button trigger modal with plus icon -->
        <button type="button" class="btn-link p-0" data-toggle="modal" data-target="#formModal" style="border: none; background: none; box-shadow: none;" onclick="editTrend('', '', '', '', '', '', '', '', 'Add Trend')">
            <img src="{{ url_for('static', filename='images/plus.svg') }}" alt="Plus Icon" width="32" height="32">
        </button>
    </div>
    <br>

    <!-- Modal -->
    <div class="modal fade" id="formModal" tabindex="-1" role="dialog" aria-labelledby="formModalTitle" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLongTitle">Add Trend</h5>
                    <button type="button" class="btn-link p-0" data-dismiss="modal" style="border: none; background: none; box-shadow: none;" onclick="editTrend('', '', '', '', '', '', '', '', '')">
                        <img src="{{ url_for('static', filename='images/x-square.svg') }}" alt="Close" width="16" height="16">
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Trend Data Entry Form -->
                    <form method="post" action="{{ url_for('trend_control') }}">
                        <input type="hidden" id="trend_id" name="trend_id" value="">
                        <div class="mb-3">
                            <label for="system_id" class="form-label">Select System:</label>
                            <select class="form-select" id="system_id" name="system_id" required>
                                {% for system in systems %}
                                <option value="{{ system['id'] }}">{{ system['device_number'] }} - {{ system['description'] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="tag_set_id" class="form-label">Select Tag Set:</label>
                            <select class="form-select" id="tag_set_id" name="tag_set_id" required>
                                {% for tag_set in tag_sets %}
                                <option value="{{ tag_set['id'] }}">{{ tag_set['tag_set_name'] }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="cycles" class="form-label">Cycles:</label>
                            <input type="number" class="form-control" id="cycles" name="cycles" value="864000" required>
                        </div>
                        <div class="mb-3">
                            <label for="cycle_time" class="form-label">Cycle Time (ms):</label>
                            <input type="number" class="form-control" id="cycle_time" name="cycle_time" step="0.1" value="0.1" required>
                            <small id="trend_duration" class="form-text text-muted"></small>
                        </div>
                        <div class="mb-3">
                            <label for="buffer_size" class="form-label">Buffer Size:</label>
                            <input type="number" class="form-control" id="buffer_size" name="buffer_size" value="100" required>
                            <small id="buffer_duration" class="form-text text-muted"></small>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">Description:</label>
                            <input type="text" class="form-control" id="description" name="description">
                        </div>
                        <button type="submit" class="btn btn-primary w-100">Save Trend</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Existing Trends Section -->
    <h2 class="mt-5">Existing Trends</h2>
    <ul class="list-group">
        {% for trend in trends %}
        <li class="list-group-item d-flex justify-content-between align-items-start">
            <div class="flex-grow-1" style="margin-right: 10px;">
                <strong>{{ trend['device_number'] }}</strong> - {{ trend['description'] }}
                <br> IP: {{ trend['plc_ip'] }} / Subnet: {{ trend['subnet'] }}
                <br> Cycles: {{ trend['cycles'] }} / Cycle Time: {{ trend['cycle_time'] }} ms / Buffer Size: {{ trend['buffer_size'] }}
                <br> Tags: {{ trend['tags'] }}
            </div>
            <div class="d-flex flex-column align-items-start">
                <!-- Safely pass the trend data -->
                <form method="post" action="{{ url_for('delete_trend', id=trend['id']) }}">
                    <button type="submit" class="btn-link p-0" style="border: none; background: none; box-shadow: none; margin-bottom: 1cap;">
                        <img src="{{ url_for('static', filename='images/x-square.svg') }}" alt="Close" width="16" height="16">
                    </button>
                </form>
                <button class="btn-link p-0" style="border: none; background: none; box-shadow: none;" data-toggle="modal" data-target="#formModal" onclick="editTrend({{ trend['id'] }}, '{{ trend['system_id'] }}', '{{ trend['tag_set_id'] }}', {{ trend['cycles'] }}, {{ trend['cycle_time'] }}, {{ trend['buffer_size'] }}, '{{ trend['description'] }}', '{{ trend['tags'] }}', 'Edit Trend')">
                    <img src="{{ url_for('static', filename='images/edit.svg') }}" alt="Edit" width="16" height="16">
                </button>
            </div>
        </li>
        {% endfor %}
    </ul>
</div>

<script>
    function editTrend(id, systemId, tagSetId, cycles, cycleTime, bufferSize, description, tags, modal_title) {
        document.getElementById('trend_id').value = id;
        document.getElementById('system_id').value = systemId;
        document.getElementById('tag_set_id').value = tagSetId;
        document.getElementById('cycles').value = cycles;
        document.getElementById('cycle_time').value = cycleTime;
        document.getElementById('buffer_size').value = bufferSize;
        document.getElementById('description').value = description;
        document.getElementById('exampleModalLongTitle').innerText = modal_title;
    }

    function calculateTrendDuration() {
        var cycles = parseInt(document.getElementById('cycles').value, 10);
        var cycleTime = parseFloat(document.getElementById('cycle_time').value);
        var bufferSize = parseInt(document.getElementById('buffer_size').value, 10);

        if (!isNaN(cycles) && !isNaN(cycleTime)) {
            // Calculate total trend duration
            var totalSeconds = (cycles * cycleTime);

            var hours = Math.floor(totalSeconds / 3600);
            var minutes = Math.floor((totalSeconds % 3600) / 60);
            var seconds = totalSeconds % 60;

            var durationText = hours + ' hours, ' + minutes + ' minutes, ' + seconds.toFixed(2) + ' seconds';
            document.getElementById('trend_duration').innerText = 'Estimated Duration: ' + durationText;
        } else {
            document.getElementById('trend_duration').innerText = '';
        }

        if (!isNaN(bufferSize) && !isNaN(cycleTime)) {
            // Calculate how often to save to file
            var fileTotalSeconds = (bufferSize * cycleTime);

            var fileHours = Math.floor(fileTotalSeconds / 3600);
            var fileMinutes = Math.floor((fileTotalSeconds % 3600) / 60);
            var fileSeconds = fileTotalSeconds % 60;

            var saveText = 'Save to file every ' + fileMinutes + ' minutes, ' + fileSeconds.toFixed(2) + ' seconds';
            document.getElementById('buffer_duration').innerText = saveText;
        } else {
            document.getElementById('buffer_duration').innerText = '';
        }
    }

    document.getElementById('cycles').addEventListener('input', calculateTrendDuration);
    document.getElementById('cycle_time').addEventListener('input', calculateTrendDuration);
    document.getElementById('buffer_size').addEventListener('input', calculateTrendDuration);

    // Initial calculation
    calculateTrendDuration();

</script>
{% endblock %}
