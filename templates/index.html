<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PLC Trend Collection Control</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <h1>PLC Trend Collection Control</h1>
    <p>Status: {{ 'Running' if script_running else 'Stopped' }}</p>

    <form method="post" action="{{ url_for('start_script') }}">
        <label for="device_number">Device Number:</label><br>
        <input type="text" id="device_number" name="device_number" required><br><br>

        <label for="trend_desc">Trend Description:</label><br>
        <input type="text" id="trend_desc" name="trend_desc" required><br><br>

        <label for="cycles">Number of Cycles:</label><br>
        <input type="number" id="cycles" name="cycles" required><br><br>

        <label for="cycle_time">Cycle Time (seconds):</label><br>
        <input type="number" id="cycle_time" name="cycle_time" required><br><br>

        <label for="buffer_size">Buffer Size:</label><br>
        <input type="number" id="buffer_size" name="buffer_size" required><br><br>

        <label for="plc_ip">PLC IP Address:</label><br>
        <input type="text" id="plc_ip" name="plc_ip" required><br><br>

        <input type="submit" value="Start Script">
    </form>

    <form method="post" action="{{ url_for('stop_script') }}" style="margin-top: 20px;">
        <input type="submit" value="Stop Script">
    </form>

    <h2>Manage Tags</h2>
    <form method="post" action="{{ url_for('add_tag') }}">
        <label for="tags">Add Tags (one per line):</label><br>
        <textarea id="tags" name="tags" rows="5" cols="40" required></textarea><br><br>
        <input type="submit" value="Add Tags">
    </form>

    <ul>
        {% for tag in tags %}
        <li>{{ tag }} 
            <form method="post" action="{{ url_for('remove_tag', tag=tag) }}" style="display:inline;">
                <input type="submit" value="Remove">
            </form>
        </li>
        {% endfor %}
    </ul>

    <h2>Recorded Data</h2>
    <div id="data_display">
        <table border="1">
            <thead>
                <tr>
                    <th>Index</th>
                    <th>DateTime</th>
                    {% for tag in tags %}
                    <th>{{ tag }}</th>
                    {% endfor %}
                </tr>
            </thead>
            <tbody id="data_rows">
                <!-- Data will be populated here by JavaScript -->
            </tbody>
        </table>
    </div>

    <script>
        function fetchData() {
            $.getJSON('{{ url_for("get_data") }}', function(data) {
                var rows = '';
                data.forEach(function(row) {
                    rows += '<tr>';
                    row.forEach(function(cell) {
                        rows += '<td>' + cell + '</td>';
                    });
                    rows += '</tr>';
                });
                $('#data_rows').html(rows);
            });
        }

        setInterval(fetchData, 2000);  // Fetch new data every 2 seconds
    </script>
</body>
</html>
